<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Корзина</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .cart-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
    }
    .quantity-input {
      width: 60px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">BobaTea</a>
    </div>
    <div id="adminPanel" style="display: none;">
        <h5>Управление товарами</h5>
        <a href="admin.html" class="btn btn-sm btn-primary">Перейти в админку</a>
      </div>
  </nav>

  <div class="container">
    <h2 class="mb-4 fw-bold text-center">Ваша корзина</h2>
    <div id="cartContainer" class="row g-3"></div>

    <div class="row mt-4">
        <div class="col-md-6 mb-3">
          <label for="promoCode" class="form-label fw-semibold">Промокод:</label>
          <div class="input-group">
            <input type="text" id="promoCode" class="form-control" placeholder="Введите промокод">
            <button class="btn btn-outline-primary" onclick="applyPromo()">Применить</button>
          </div>
          <div class="form-text">Промокод "080525" даст 20% скидку.</div>
          <br>
          <div class="mb-3">
            <label for="userEmail" class="form-label fw-semibold">Email для уведомлений:</label>
            <input type="email" class="form-control" id="userEmail" placeholder="Ваш email">
          </div>
        </div>
        
        <div class="col-md-6 text-end">

          <p>Скидка: <strong id="discountAmount">₽0</strong></p>
          <p>Доставка: <strong id="deliveryFee">₽0</strong></p>
          <h4>Итого: <span id="totalPrice">₽0</span></h4>
          <button class="btn btn-dark mt-2" onclick="submitOrder()">Оформить заказ</button>
          <div id="orderMessage" class="mt-3 text-success fw-semibold"></div>        </div>
      </div>
    </div>
    <script type="module" src="firebase.js"></script>
    <script type="module" src="main.js"></script>
    <script>
    const db = firebase.firestore();

    const cartContainer = document.getElementById('cartContainer');
    const totalPriceEl = document.getElementById('totalPrice');

    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function renderCart() {
        cartContainer.innerHTML = '';
        let subtotal = 0;

        if (cart.length === 0) {
            cartContainer.innerHTML = "<p class='text-center text-muted'>Корзина пуста.</p>";
            document.getElementById("totalPrice").textContent = "₽0";
            document.getElementById("discountAmount").textContent = "₽0";
            document.getElementById("deliveryFee").textContent = "₽0";
            return;
        }

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            cartContainer.innerHTML += `
            <div class="col-12">
                <div class="d-flex align-items-center border rounded p-3 shadow-sm justify-content-between flex-wrap">
                <div class="d-flex align-items-center gap-3">
                    <img src="${item.img}" class="cart-img" alt="${item.title}">
                    <div>
                    <h5 class="mb-1">${item.title}</h5>
                    <p class="mb-1 text-muted">Размер: ${item.size}</p>
                    <p class="mb-1 fw-semibold">₽${item.price} / шт.</p>
                    <div class="d-flex align-items-center gap-2">
                        <label for="qty-${index}" class="form-label mb-0">Кол-во:</label>
                        <input type="number" id="qty-${index}" min="1" value="${item.quantity}" class="form-control form-control-sm quantity-input" onchange="updateQuantity(${index}, this.value)">
                    </div>
                    </div>
                </div>
                <div class="mt-3 mt-md-0">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">Удалить</button>
                </div>
                </div>
            </div>
            `;
        });

        calculateTotals(subtotal);
    }
    let discount = 0;
    let delivery = 0; // допустим, пока бесплатная

    function applyPromo() {
    const code = document.getElementById("promoCode").value.trim();
    if (code === "080525") {
        discount = 0.2; // 20%
    } else {
        discount = 0;
        alert("Промокод недействителен.");
    }
    renderCart(); // пересчитать
    }

    function calculateTotals(subtotal) {
    const discountAmount = Math.round(subtotal * discount);
    const total = subtotal - discountAmount + delivery;

    document.getElementById("discountAmount").textContent = `₽${discountAmount}`;
    document.getElementById("deliveryFee").textContent = `₽${delivery}`;
    document.getElementById("totalPrice").textContent = `₽${total}`;
    }
    function updateQuantity(index, newQty) {
      newQty = parseInt(newQty);
      if (newQty < 1) newQty = 1;

      cart[index].quantity = newQty;
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      console.log(cart)
    }

    function removeItem(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function clearCart() {
      if (confirm("Вы уверены, что хотите очистить корзину?")) {
        localStorage.removeItem("cart");
        cart = [];
        renderCart();
      }
    }

    // Инициализация при загрузке
    renderCart();
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById("userEmail").value = user.email;
      }
    });
    auth.onAuthStateChanged(async user => {
    const emailEl = document.getElementById("userEmailDisplay");
    const logoutBtn = document.getElementById("logoutBtn");

    if (user) {
        emailEl.textContent = `Вы вошли как: ${user.email}`;
        logoutBtn.style.display = "inline-block";

        // Проверка роли
        const roleDoc = await db.collection("roles").doc(user.uid).get();
        if (roleDoc.exists && roleDoc.data().role === "admin") {
        console.log("Вы админ");
        showAdminPanel(); // вызывай свою функцию показа админ-функций
        } else {
        console.log("Обычный пользователь");
        }

        logoutBtn.addEventListener("click", () => {
        auth.signOut().then(() => location.reload());
        });
    } else {
        emailEl.textContent = '';
        logoutBtn.style.display = "none";
    }
    });

    auth.onAuthStateChanged(user => {
    if (user && user.email) {
      document.getElementById("userEmail").value = user.email;
    }
  });
  function showAdminPanel() {
  document.getElementById("adminPanel").style.display = "block";
}
async function submitOrder() {
    const emailInput = document.getElementById("userEmail");
    const email = emailInput.value.trim();
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    if (!email) {
      alert("Пожалуйста, введите email для получения уведомлений.");
      return;
    }

    if (cart.length === 0) {
      alert("Корзина пуста.");
      return;
    }

    const timestamp = new Date().toISOString();
    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const order = {
      email,
      items: cart,
      total,
      createdAt: timestamp
    };

    try {
      const docRef = await db.collection("orders").add(order);
      document.getElementById("orderMessage").textContent = "Заказ успешно оформлен!";
      localStorage.removeItem("cart");
      renderCart(); // обновляем корзину
    } catch (error) {
      console.error("Ошибка при отправке заказа:", error);
      alert("Произошла ошибка при оформлении заказа.");
    }
  }
    </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
